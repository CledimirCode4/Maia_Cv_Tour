<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-5">
        <h2>Reservar</h2>
        <p>Reserve o seu lugar para o tour</p>
        <form id="payment-form">
            <div class="form-group">
                <label for="lugar" class="label-control">Lugar</label>
                <input type="text" class="form-control" id="lugar" name="lugar" required>
            </div>
            <div class="form-group">
                <label for="distancia" class="label-control">Distância (km)</label>
                <input type="number" class="form-control" id="distancia" name="distancia" required>
            </div>
            <div class="form-group">
                <label for="hora" class="label-control">Hora</label>
                <input type="time" class="form-control" id="hora" name="hora" required>
            </div>
            <div class="form-group">
                <label for="servico" class="label-control">Serviço</label>
                <select class="form-control" id="servico" name="servico" required>
                    <option value="Tour">Tour</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="preco" class="label-control">Preço (CVE)</label>
                <input type="number" class="form-control" id="preco" name="preco" required>
            </div>
            <button type="button" id="checkout-button" class="mt-3 btn btn-primary">Pagar Agora</button>
        </form>
    </div>

    <script>
        var stripe = Stripe("pk_test_51PwMLLE96mrdqv9LFinK9GuAsQPIzr1iV7G846ih3zO0UZBvQbuqyPdH5IOXhF3Fz7jJroviE3cHtK8nUaqYiKOy00SxdhPpAe");

        document.getElementById("checkout-button").addEventListener("click", function () {
            let lugar = document.getElementById("lugar").value;
            let distancia = document.getElementById("distancia").value;
            let hora = document.getElementById("hora").value;
            let servico = document.getElementById("servico").value;
            let preco = document.getElementById("preco").value;

            if (!lugar || !distancia || !hora || !preco || !servico) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            fetch("/stripe_payment/create-checkout-session/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")  // Proteção CSRF se necessário
                },
                body: JSON.stringify({
                    place: lugar,
                    distance: distancia,
                    time: hora,
                    service: servico,
                    preco: preco
                })
            })
            .then(response => response.json())
            .then(session => {
                if (session.error) {
                    alert("Erro ao criar sessão de pagamento: " + session.error);
                } else {
                    return stripe.redirectToCheckout({ sessionId: session.id });
                }
            })
            .catch(error => console.error("Erro:", error));
        });

        // Função para pegar o CSRF token do cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>
